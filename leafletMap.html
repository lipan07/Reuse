import React, { Component } from 'react';
import { View, ScrollView, Text, Image, StyleSheet, TouchableOpacity } from 'react-native';
import { WebView } from 'react-native-webview';
import { useNavigation } from '@react-navigation/native';
import AsyncStorage from '@react-native-async-storage/async-storage';
import BottomNavBar from './BottomNavBar';

class ProductDetails extends Component {
    constructor(props) {
        super(props);
        this.state = {
            buyerId: null,
        };
    }

    componentDidMount() {
        this.loadBuyerId();
    }

    loadBuyerId = async () => {
        try {
            const storedBuyerId = await AsyncStorage.getItem('userId');
            this.setState({ buyerId: storedBuyerId });
        } catch (error) {
            console.error('Failed to load buyer ID:', error);
        }
    };

    handleChatWithSeller = () => {
        const { buyerId } = this.state;
        const { product } = this.props.route.params;
        if (buyerId) {
            this.props.navigation.navigate('ChatBox', {
                sellerId: product.user_id,
                buyerId,
                postId: product.id
            });
        } else {
            console.log("Buyer ID not found");
        }
    };
    const handleCallPress = () => {
        // Handle call functionality...
    };

    const handleCompanyNamePress = () => {
        navigation.navigate('CompanyDetailsPage', 'Malaq');
    };

    const handleMapPress = () => {
        // Navigate to the FullScreenMap screen
        navigation.navigate('FullScreenMap', {
            latitude: 22.5726,
            longitude: 88.3639,
        });
    };

    createLeafletMapHTML = (latitude, longitude) => {
        const htmlContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Simple Map</title>
            <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
            <style>
                body, html, #map { height: 100%; margin: 0; padding: 0; }
            </style>
        </head>
        <body>
            <div id="map"></div>
            <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
            <script>
                var map = L.map('map').setView([${latitude}, ${longitude}], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(map);
                L.marker([${latitude}, ${longitude}]).addTo(map)
                    .bindPopup("Location")
                    .openPopup();
            </script>
        </body>
        </html>
        `;
        return `${htmlContent}`;
    };

    render() {
        const { product } = this.props.route.params;
        const mapHtml = this.createLeafletMapHTML(product.latitude || 22.5726, product.longitude || 88.3639);

        return (
            <View style={styles.container}>
                <ScrollView>
                    <ScrollView horizontal showsHorizontalScrollIndicator={false} style={styles.imageContainer}>
                        {product.images.map((image, index) => (
                            <TouchableOpacity key={index} onPress={() => {
                                this.props.navigation.navigate('ImageViewer', { images: product.images, selectedImageIndex: index });
                            }}>
                                <Image source={{ uri: image }} style={styles.image} />
                            </TouchableOpacity>
                        ))}
                    </ScrollView>

                    <View style={styles.detailsCard}>
                        <Text style={styles.companyName} onPress={() => this.props.navigation.navigate('CompanyDetailsPage', 'Malaq')}>
                            Company: {product.companyName}
                        </Text>
                        <Text style={styles.productTitle}>{product.title}</Text>
                        <Text style={styles.description}>{product.post_details.description}</Text>
                        <Text style={styles.price}>Price: ${product.post_details.amount}</Text>

                        <View style={styles.mapContainer}>
                            <WebView
                                originWhitelist={['*']}
                                source={{ html: mapHtml }}
                                style={styles.map}
                                javaScriptEnabled={true}
                                domStorageEnabled={true}
                            />
                        </View>
                    </View>
                </ScrollView>

                {this.state.buyerId !== product.user_id && (
                    <View style={styles.buttonContainer}>
                        <TouchableOpacity style={styles.chatButton} onPress={this.handleChatWithSeller}>
                            <Text style={styles.buttonText}>Chat</Text>
                        </TouchableOpacity>

                    <TouchableOpacity style={styles.callButton} onPress={handleCallPress}>
                        <Text style={styles.buttonText}>Call</Text>
                    </TouchableOpacity>
                    </View>
                )}

                <BottomNavBar />
            </View>
        );
    }
}

const styles = StyleSheet.create({
    container: { flex: 1, backgroundColor: '#f8f9fa' },
    imageContainer: { paddingVertical: 10, paddingHorizontal: 15 },
    image: { width: 250, height: 300, marginRight: 15, borderRadius: 10, resizeMode: 'cover' },
    detailsCard: {
        backgroundColor: '#ffffff', borderRadius: 10, padding: 20, margin: 15,
        shadowColor: '#000', shadowOpacity: 0.1, shadowRadius: 5, elevation: 3
    },
    companyName: { fontSize: 18, fontWeight: '600', color: '#007bff', marginBottom: 5 },
    productTitle: { fontSize: 22, fontWeight: 'bold', marginBottom: 10, color: '#343a40' },
    description: { fontSize: 16, color: '#6c757d', marginBottom: 15 },
    price: { fontSize: 20, fontWeight: 'bold', color: '#28a745' },
    mapContainer: { height: 300, margin: 20, borderWidth: 1, borderColor: '#ccc', borderRadius: 10, overflow: 'hidden' },
    map: { height: '100%' },
    buttonContainer: {
        flexDirection: 'row', justifyContent: 'space-between', paddingHorizontal: 20, paddingVertical: 15,
        backgroundColor: '#ffffff', borderTopWidth: 1, borderColor: '#dee2e6'
    },
    chatButton: {
        backgroundColor: '#007bff', paddingVertical: 12, paddingHorizontal: 30, borderRadius: 30, flex: 1, marginRight: 10, alignItems: 'center'
    },

    callButton: {
        backgroundColor: '#28a745',
        paddingVertical: 12,
        paddingHorizontal: 30,
        borderRadius: 30,
        flex: 1,
        marginLeft: 10,
        alignItems: 'center',
    },
    buttonText: { color: '#ffffff', fontSize: 16, fontWeight: 'bold' },
});

export default ProductDetails;
